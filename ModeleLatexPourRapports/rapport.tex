\documentclass[11pt,oneside,noprintercorrection]{ustl}
\usepackage[T1]{fontenc}
%----------------------------------------------------------------------
%                     Chargement de quelques packages
%----------------------------------------------------------------------


% Si l'on veut produire une version PDF avec distiller ou pdflatex :
%\usepackage{tlhypref}
\usepackage[pdfborder=0 0 0]{ustl}
% Si l'on produit le PDF avec pdflatex, ceci remplace la plupart
% des polices EC par des polices CM, plus adaptees a la generation de PDF,
% car ayant des equivalents PS :
% obsolÃ¨te ?? \usepackage{aeguill}


% Pour les figures PS :
\usepackage{graphicx}

% Si on veut des mini-tables des matieres (utiliser minitoc-hyper
% en conjonction avec tlhypref) :
\usepackage[french]{minitoc}
%\usepackage[french]{minitoc-hyper}
\usepackage[frenchb]{babel}
\usepackage{graphicx}
\usepackage{float}

% Pour les codes
\usepackage{listings}
\lstset{language=C++,basicstyle=\small}

\synctex = 1




\makeatletter

%
% les deux commandes suivantes sont entre \makeatletter
% et \makeatother parce qu'elles utilisent des `@'.
%

\renewcommand{\@DFD}{Université Lille 1}


\renewcommand{\@NancyIhe@d}{{\UseEntryFont{ThesisFirstPageHead}\noindent
    \centerline{\if@logo@uhp@
                    {\setbox0=\hbox{$\raise2.3cm\hbox{\UHPLogo}$}%
                     \ht0=\baselineskip\box0}\hfill
                \else
                    Université des Sciences et Technologies de Lille%
                \fi}%
    \@TL@cmn@head\\
    \par
    }%
    }


\newcommand\TheseLilleI{\renewcommand{\@ThesisFirstPageHead}{\@NancyIhe@d}%
                         \ThesisDiploma{{\UseEntryFont{ThesisDiploma}%
                              \\[3mm]
            {\UseEntryFont{ThesisSpecialty}( )}}}}

\makeatother

%-------------------------------------------------------------------
%           Corrections pour les imprimantes recto-verso
%                          (A AJUSTER)
%-------------------------------------------------------------------

%\ShiftOddPagesRight{-1mm}
%\ShiftOddPagesDown{2.5mm}
%\ShiftEvenPagesRight{0mm}
%\ShiftEvenPagesDown{0mm} 

%-------------------------------------------------------------------
%                Mise en page
%-------------------------------------------------------------------

%-------------------------------------------------------------------
%                             interligne
%-------------------------------------------------------------------
\renewcommand{\baselinestretch}{1.3}

%-------------------------------------------------------------------
%                             Marges
%-------------------------------------------------------------------

% pour positionner les vraies marges:
%\SetRealMargins{1mm}{1mm}

%-------------------------------------------------------------------
%                             En-tetes
%-------------------------------------------------------------------
%On n'utilise pas les logos
%\DontShowLogos

% Les en-tetes: quelques exemples
%\UppercaseHeadings
%\UnderlineHeadings
%\newcommand\bfheadings[1]{{\bf #1}}
%\FormatHeadingsWith{\bfheadings}
%\FormatHeadingsWith{\uppercase}
%\FormatHeadingsWith{\underline}
\newcommand\upun[1]{\uppercase{\underline{\underline{#1}}}}
\FormatHeadingsWith\upun

\newcommand\itheadings[1]{\textit{#1}}
\FormatHeadingsWith{\itheadings}

% pour avoir un trait sous l'en-tete:
\setlength{\HeadRuleWidth}{0.4pt}

%-------------------------------------------------------------------
%                Chemin d'inclusion des graphiques
%-------------------------------------------------------------------

\graphicspath{{img/}{./}}

%-------------------------------------------------------------------
%                         Les references
%-------------------------------------------------------------------

\NoChapterNumberInRef \NoChapterPrefix

%-------------------------------------------------------------------
%                           Brouillons
%-------------------------------------------------------------------

% ceci ajoute une marque `brouillon' et la date
%\ThesisDraft



\begin{document}
\renewcommand{\labelitemi}{$\bullet$}
\renewcommand{\labelitemii}{$\circ$}
%-------------------------------------------------------------------
%                          Encadrements
%-------------------------------------------------------------------

% encadre les chapitres dans la table des matieres:
% (ces commandes doivent figurer apres \begin{document}

%\FrameChaptersInToc
%\FramePartsInToc


%-------------------------------------------------------------------
%            Reinitialisation de la numerotation des chapitres
%-------------------------------------------------------------------

% Si la commande suivante est presente,
% elle doit figurer APRES \begin{document}
% et avant la premiere commande \part
\ResetChaptersAtParts

%-------------------------------------------------------------------
%               mini-tables des matieres par chapitre
%-------------------------------------------------------------------

% preparer les mini-tables des matieres par chapitre.
% (commande de minitoc.sty)
%\dominitoc

%-------------------------------------------------------------------
%                         Page de titre:
%-------------------------------------------------------------------


\ThesisKind{Rapport de stage de Master 2}
\ThesisPresentedThe{soutenu le 1er Septembre 2015}
\ThesisTitle{Création et développement au sein de SOFA} 
\ThesisAuthor{Tony GALLOY}
%\NomDuLaboOuEntreprise{INRIA Equipe DEFROST}
%\LogoLaboOuEntreprise{alcove} % Image du logo du labo ou ets dans le rep img

\NomDuLaboOuEntreprise{}
\LogoLaboOuEntreprise{} % Image du logo du labo ou ets dans le rep img

\TheseLilleI

\NewJuryCategory{encadrant}{\it Encadrant :}
                        {\it Encadrants :}

%\encadrant = {Nom encadrant 1\\
%              Nom encadrant 2}

% Creation de la page de titre:
\MakeThesisTitlePage



%-------------------------------------------------------------------
\SpecialSection{Résumé}
\section{Résumé du stage}

J'ai effectué un stage de quatre mois et demi au sein de l'équpe DEFROST de INRIA à Villeneuve d'ascq. 
Ce rapport a pour but de présenter les travaux réalisés durant mon stage de master dans l'équipe DEFROST à INRIA. Il détaillera une méthode afin de rendre de la stéréovision dans un moteur graphique quelconque destiné à des casques de réalité virtuelle et la création d'une simulation d'opération d'un anévrisme cérébral.



\section{Summary}

I did an internship of four and a half months inside the DEFROST TEAM from INRIA in Villeneuve d'ascq.
This report aims to present the work done during this internship. It will detail a method to make stereovision in any graphics engine for virtual reality headsets and the creation of an operating simulation of a brain aneurysm.

%-------------------------------------------------------------------
%                          remerciements
%-------------------------------------------------------------------

%\DontFrameThisInToc
\begin{ThesisAcknowledgments}
\begin{itemize}
\item Je remercie Mr Mario Sanz Lopez pour son soutien sur le matériel disponible.
\item Je remercie également Mr Bruno CARREZ pour ses conseils de développement
\item Je remercie Mr Julien BOSMAN pour son aide à plusieurs reprises à propos des modélisations 3D et utilisation de Blender
\item Je remercie Mme Eulalie COEVOET ainsi qu'a Mr Jeremie DEQUIDT pour leur support concernant SOFA.
\item Je remercie Mr Damien Marchal pour ses conseils sur mon rapport de stage
\item Enfin je remercie tout particulièrement mon tuteur Christian DURIEZ qui m'a proposé ce stage dans son équipe et qui m'a encadré durant mon stage ainsi que Mr Laurent THINES qui m'a permis d'assister à une opération chirurgicale.
\end{itemize}


\end{ThesisAcknowledgments}


%-------------------------------------------------------------------
%                  ecriture de `Chapitre' et `Partie'
%                      dans la table des matieres
%-------------------------------------------------------------------

\WritePartLabelInToc \WriteChapterLabelInToc

%-------------------------------------------------------------------
%                        table des matieres
%-------------------------------------------------------------------

\tableofcontents

%-------------------------------------------------------------------
%              Exemple d'utilisation de \SpecialSection
%-------------------------------------------------------------------

% La commande \mainmatter (nouvelle commande LaTeX2e) permet de passer
% a la numerotation arabe (ce que fait \pagenumbering{arabic})
% et de faire commencer la nouvelle page 1 sur une page impaire.
% On evitera donc d'utiliser directement \pagenumbering{arabic}.
\mainmatter

% ----------------------------------------------------------------
\SpecialSection{Introduction}
Les étudiants français en médecine passent une grande partie de leurs études en stage auprès des établissements hospitaliers français. Plus ils avancent dans leurs études, plus ils ont de temps à consacrer aux exercices en bloc opératoire.
    Les seuls manières de pratiquer en cours sont la dissection et l'opération sur des cadavres, mais les conditions de conservation et les limitations en nombre de ces corps empêchent de pratiquer certains maux. La grande variété des pathologies étudiés ne peut donc être découverte en cours, les étudiants sont donc poussés vers les hôpitaux afin d'avoir l'opportunité de rencontrer le plus de ces pathologies possibles. 
    Afin de contourner ce problème, de nombreuses équipes dans le monde professionnel et scientifique se mettent à travailler sur des simulations, et de nombreux outils sont créés afin d'aider à l'immersion dans les simulations proposées. 
    Nous allons dans un premier temps présenter l'opération de l'anévrisme. Nous continuerons ensuite détailler à l'aide d'expériences formatrices les besoins et problématiques de la création d'une simulation. Puis nous présenterons le moteur choisi ainsi que quelques unes des fonctionnalités qu'il propose. Nous enchaînerons  avec la réalisation de la simulation. Enfin, nous finirons avec un moyen de remplacer les microscopes dans la simulation.

% Pour ne pas avoir le mot `Chapitre' au debut de chaque chapitre.
\NoChapterHead

%--------------------------------------------------------------------------------------
%--------------------------------------------------------------------------------------

\SpecialSection{Table des abréviations et des sigles}
\listoffigures  % table des figures
%\listoftables   % table des tableaux


\chapter{Description de l'anévrisme}
L'anévrisme est une dilatation anormale de certaines artères du corps, et plus rarement de veines ou du coeur, qui vont se gonfler de sang. Cet anévrisme grossit avec le temps, et il arrive qu'il se rompt, déclenchant une hémorragie locale. Il existe actuellement deux moyens de soigner un anévrisme. Ce travail est tiré du livre : Encyclopédie familiale de la santé. 
\cite{familiale}
\section{Soin par cathéter}
    Un cathéter est un câble creux de longueur variable  que l'on va amener jusqu'à l'anévrisme par les voies naturelles du corps tel que les vaisseaux sanguins. Celui-ci va ensuite servir de passage jusqu'à la région d'intérêt pour un filament métallique, où il va progressivement être poussé et remplir la poche, formant une pelote. Ce filament est imbibé d'une substance qui va se solidifier, et finir par boucher complètement l'anévrisme. 
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{Embolisation}
  \caption{Embolisation d'un anévrysme}
  \label{fig:ustl}
\end{figure}
\section{Soin par chirurgie}
    L'anévrisme possède un resserrement à sa base. On appelle ce resserrement le collet de l'anévrisme. Cette méthode consiste à poser une pince sur ce collet, afin d'isoler complètement l'anévrisme.
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{Clampage}
  \caption{Clampage d'un anévrysme}
  \label{fig:ustl}
\end{figure}
Nous allons donc voir maintenant comment se déroule une opération par chirurgie. Dans notre cas, nous ne nous intéresseront qu'à l'anévrisme cérébral. 
\subsection{La préparation}
Avant une opération d'anévrisme cérébral, chaque patient doit passer une IRM(Imagerie par résonance magnétique). 
L'IRM est une technique d'imagerie médicale permettant d'obtenir des vues en deux puis en trois dimension de l'intérieur du corps. Cette technique est non-invasive et inoffensive pour le patient.
L'IRM enregistre couche par couche les différentes parties du cerveau et permet de naviguer parmi ces couches. Ces images sont par la suite enregistrées pour pouvoir être utilisées par la suite. 
Juste avant l'opération, le neurochirurgien va analyser l'IRM. Il va modéliser les différents organes et établir une stratégie d'accès à l'anévrisme. Cette modélisation l'aidera durant toute l'opération.
\subsection{L'opération}
    Le soin s'effectue dans un bloc opératoire. Le chirurgien commence par fixer la tête du patient grâce à un serre-tête solidement fixé et verrouillé au siège. Une fois stabilisé, le chirurgien dégage la peau et les muscles du crâne. 
    Une fois la chair découpée et écartée, les neurochirurgiens doivent ouvrir le crâne afin d'accéder au cerveau. On appelle ce chemin la voie d'abord. Elle est standard et fixe.
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{Voletpterionalstandard}
  \caption{Le volet ptérioral standard, zone de la voie d'abord}
  \label{fig:ustl}
\end{figure}

Le neurochirurgien va d'abord brûler le crâne grâce à une pince électrique, afin de dessiner 3 cercles et les liens entre ces trois cercles. Il va ensuite découper l'os en suivant les traits, et enlever le morceau d'os restant.
    A ce moment, le neurochirurgien va placer un microscope à pied au dessus de la voie d'abord. C'est ce microscope qui bougera si le médecin souhaite changer de vue, et ce médecin effectuera le reste de l'opération au travers de ce microscope.
    Il va tout d'abord sectionner les bris reliant les deux parties du cerveau afin de pouvoir écarter ces deux parties. Il aura ainsi accès à l'anévrisme. Mais ce dernier peut être lui même attaché par des fibres aux organes l'entourant, le chirurgien va donc séparer l'anévrisme du reste des organes. La première raison est que l'anévrisme est gorgé de sang, il est donc gonflé et facilement manipulable. La seconde raison est que le chirurgien sera capable après de manipuler l'anévrisme afin de le placer dans une position favorable. 
    Une fois l'anévrisme désolidarisé, l'opérateur va venir clipser le collet de l'anévrisme, grâce à une petite pince métallique. Il va ensuite percer l'anévrisme avec une seringue, afin d'absorber le sang contenu dans la poche, puis va sectionner l'anévrisme. Si la pince est mal mise, le patient risque une hémorragie. Afin donc de vérifier l'isolation de l'anévrisme, et de voir une quelconque mauvaise circulation du sang, une substance particulière luminescente va être inséré dans le sang du patient. Et grâce à un mode particulier du microscope, le sang va s'illuminer. Il est ainsi possible d'observer toute mauvaise manipulation sur le cerveau, ou sur les organes autour. 
    Pour finir, le neurochirurgien va replacer le morceau de crâne découpé, le fixer avec des rivets particuliers, et recoudre la peau du patient.

    Il peut arriver qu'une erreur se produise, et que l'anévrisme se rompt. Le médecin doit alors venir bloquer l'artère avec une pince. On appelle cela le clampage. Une fois l'artère bloqué, le médecin possède un temps limité pour venir clipser l'anévrisme puis enlever la pince de clampage afin d'éviter tout risque définitif pour le patient.

En plus du travail bibliographique précédent, on m'a proposé deux expériences afin d'analyser les besoins des futurs utilisateurs
\section{L'opération de l'anévrisme}
    Afin de préparer au mieux mon approche des travaux, on m'a proposé de me rendre à l'hôpital Salengro de Lille pour assister à une opération d'ablation d'un anévrisme cérébral. Plusieurs détails sont à noter.
    Tout d'abord, les chirurgiens utilisent un serre tète très solidement fixé sur la table d'opération. Il positionne la tète légèrement incliné, afin de placer l'endroit ou le chirurgien va percer l'os sur le haut. Et cette position ne changera pas de toute l'opération.
    Ensuite, l'opération à demandé 5 personnes. L'équipe était composée de 2 externes chargés de préparer le matériel et  de surveiller l'état du patient, un interne qui assistait le neurochirurgien, tout en observant attentivement, et une assistante expérimentée qui préparait les outils que le neurochirurgien devait utiliser.    
Une grande partie de l'opération a été réalisé au travers du microscope, et le médecin déplaçait ce microscope à chaque fois qu'il souhaitait avoir un point de vue différent. L'utilisation du microscope a été justifiée par la taille de la voie d'abord extrêmement petite (~25 cm2). Les mouvements du neurochirurgien étaient également très précis et de très faible amplitude.
Le neurochirurgien est sujet à un stress important durant l'opération. 
    Enfin, l'opération a duré 7 heures sans pause.

\section{Le congres de neurochirurgie}
    Dans le but de me familiariser avec les tâches que l'on m'a confié, mais aussi de comprendre les besoins des neurochirurgiens en terme de simulation, j'ai eu la chance de participer à un congrès appelé "Société Française de Neurochirurgie". Basé à la cité internationale des congrès de Nantes, elle a regroupé pendant 3 jours des chercheurs et des entreprises. Des présentations par des chercheurs étaient programmées, et de nombreux stands étaient disposés dans la salle principale afin de présenter les dernières nouveautés en terme d'équipements et de recherches.
    L'un des outils ressemblait particulièrement à ce qui doit être fait. Il s'agit d'une plate-forme mobile de simulation appelée Neurotouch. Elle est équipée d'un stéréoscope mécanique qui permet de percevoir la 3D grâce à un seul écran. La plate-forme dispose de plusieurs simulations basées sur les Phantom omnis, tel qu'une opération de suppression d'une tumeur par aspiration. Après expérimentation, les outils répondent bien aux mouvements, et les comportements des différents outils sont satisfait par le matériel fourni par la station. 
    Plusieurs projets sont nés autour des casques de réalité virtuelle. Ils n'étaient présents qu'en tant que démonstrations, mais les applications semblent prometteuses, notamment un projet de vidéo filmée à 360°. Les responsables ont filmé une opération chirurgicale du point de vue du chirurgien. Cela permet une immersion totale dans la scène filmée, et pourra certainement aider les nouveaux étudiants à appréhender le stress de l'opération.
    Nous avons pour notre part présenté les travaux sur l'opération de l'anévrisme cérébral aux médecins présents lors du congrès. Ils ont tous été surpris par les capacités de déformation des  parties du cerveau et de l'anévrisme. 

\chapter{Création de la simulation}
Maintenant que nous connaissons les besoins des utilisateurs et le déroulement de l'opération, nous pouvons diviser les principales parties de l'opération à modéliser :
\begin{itemize}
\item La découpe du crâne
\item La séparation des tissus entre les lobes de cerveau
\item La séparation des bris pour libérer l'anévrisme
\item Le clippage de l'anévrisme
\item Le clampage de l'artère
\end{itemize} 
Les parties intracrâniennes des simulations ont déjà été réalisées par un autre membre de l'équipe. Nous allons nous intéresser pour la suite de ce rapport à la réalisation de la partie "Découpe du crâne".

\section{SOFA}
Nous avons choisi SOFA, un framework développé et maintenu par des équipes de l'INRIA. SOFA est implémenté en C++, est compatible Windows, Mac et Linux, et le code est libre. Ce framework possède la particularité de fournir de nombreux outils afin d'aider à la conception de simulations. De plus, les simulations intracrâniennes ont été réalisées avec SOFA, cela permettra donc une continuité des travaux.


\chapter{Modélisation}
Nous allons dans cette partie nous concentrer sur la modélisation des outils de l'opération
    
\section{Modélisation de l'outil}
Le seul outil à modéliser est la pince électrique. 
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{pince-bistouris-electriques-baionnette-irrigation-68645-107285}
  \caption{Une pince électrique, allumé par une pédale}
  \label{fig:ustl}
\end{figure}
F
Cette pince peut être remplacée par un outil avec un simple embout, étant donné que les deux mâchoires doivent être quasiment en contact pour délivrer un courant, et que le dessin est simplement désigné par un trait sur le crâne. 
\subsection{Modélisation géométrique}
J'ai donc choisi comme représentation un stylo, car il permet de symboliser le point de contact avec sa pointe. L'origine est placé sur celle-ci.
\begin{figure}[!ht]
  \centering
  \includegraphics[height=5cm]{Stylot_short}
  \caption{Représentation géométrique du stylo}
  \label{fig:ustl}
\end{figure}

\subsection{Modélisation collisionnelle}
Les modèles de collision ont besoin d'être simplifiés au maximum afin de conserver un temps de calcul minimal. Le maillage du stylo a été remplacé par une première partie en forme de cône, ainsi que le corps par un cylindre
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{Stylot_collision_short}
  \caption{Représentation collisionnel du stylo}
  \label{fig:ustl}
\end{figure}
Modélisation du crâne
    Une fois l'outil créé, il faut modéliser un crâne humain. Plusieurs objectifs sont à réaliser.

\section{Les images}
    
    Nous avons utilisé une image d'un crâne générique.
    Il existe un plugin Image dans SOFA qui permet de traiter des images. Celui-ci contient plusieurs composants capable de charger des images et de les transformer.
Les scans IRM produisent des données volumiques en bitmap dont le niveau de gris représente la densité. Notre crâne générique possède également ces caractéristiques. Pour être exploitable, on souhaite extraire certaines structures anatomiques pertinentes par segmentation en fonction des niveaux de gris. Les structures ainsi extraites sont alors converties sous forme de maillage surfacique    

\section{Le marching cube}

    Le MarchingCube est une technique publiée en 1987 par William E. Lorensen  et Harvey E. Cline. Elle permet de transformer une image 3D en maillage. L'idée est de séparer l'espace en cubes de tailles identiques, indépendemment de l'image source. Pour chaque sommet, on calcule une moyenne des valeurs de l'image représenté par ce sommet. On définit une valeur, appelé Iso-value. Cette valeur est une valeur seuil qui va nous indiquer si le sommet actuel est dans la figure ou son contraire. Ainsi, les sommets seront segmentés binairement. Pour chaque cube, on récupère les valeurs de chaque sommet.Pour les 8 sommets de chaque cube, on se retrouve avec un octet représentant les différentes possibilités de remplissage, soit 256 valeurs de référence. On construit par la suite un tableau de références. Ce tableau contiendra les différents modèles de remplissage de cube en fonction de son index. Mais il est possible de simplifier les calculs car certains modèles sont simplement des rotations d'autres modèles. Enfin, pour chaque octet calculé on prend la correspondance dans le tableau de référence. On obtient ainsi un maillage complet associé à l'image de départ.

\section{Les Octree}
    L'octree est une structure de données hiérarchiques régulières\cite{GPUGems}. Le premier n?ud de l'arbre est un cube. Chaque n?ud peut posséder soit 8 fils soit aucun. Les 8 fils forment une subdivision régulière 2*2*2 du n?ud père.
Chaque cube va être subdivisé tant qu'il y a des voxels pleins dans l'espace du cube analysé, sinon on arrête la branche récursive actuelle. 
    On se retrouve ainsi avec une succession de points qu'il est possible de transformer en maillage 3D grâce à un tableau de référence de la même manière que le MarchingCubes.
    L'un des avantages de l'octree réside dans son organisation en arbre. Si on vient à modifier des voxels, seul une partie de l'arbre devra être recalculé. Il permet également de passer efficacement les zones vides. Enfin, le tri et les opérations de recherches sont rapides dû à l'organisation en arbre.
    Un inconvénient est la gestion des exceptions qui dépend du niveau auquel on remonte dans l'arbre afin d'obtenir les voisins. 
    

Le Marching Cube est déjà implémenté dans SOFA, contrairement à l'octree concernant les images 3D.
\section{Le modèle de collision}
    Les tests de collision dans les moteurs de jeu ont toujours été très coûteux en temps de calcul. En effet, afin de détecter une collision, on doit tester tous les triangles des deux maillages entre eux. Cela peux atteindre des temps de calculs en (N*N). C'est pourquoi la solution est d'utiliser deux maillages. Le premier maillage servira à afficher l'objet. Celui-ci pourra être détaillé afin de rendre quelque chose de fidèle. Le second sera un maillage très épuré qui reprendra la forme globale du maillage visuel.
    
    Blender fournit un composant "decimate". Ce composant va permettre d'effacer des points d'un maillage, tout en prenant en compte la forme de celui-ci. Blender nous laisse le choix du pourcentage de triangles restants sur le maillage. 
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{Crane_100_100_cote_short}
  \caption{Maillage original du crâne}
  \label{fig:ustl}
\end{figure}


\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{Crane_06_100_cote_short}
  \caption{Maillage décimé à 94 \%, il reste 6\% du maillage d'origine, et la forme est conservé}
  \label{fig:ustl}
\end{figure}

La forme globale du crane a été conservé, tandis que les triangles superflus ont été supprimés.
\section{Les mappings en SOFA}
    Le mapping est le mécanisme qui lie deux maillages entre eux. C'est à dire que toute modification ou force appliquée à l'un des maillages va se transférer à l'autre. Cette liaison dépend du type de mapping utilisé dans les simulations.
    Nous avons utilisé dans la scène un mapping Rigide. Ce type de mapping considère les maillages comme non déformables. Ainsi, toute force appliquée où que ce soit sur l'un des maillages est équivalent à l'appliquer à son centre. Une fois toutes les forces calculées, l'objet se déplacera. 
	Dans la simulation, les modèles de collisions sont mappés sur les maillages affichés.
    
\chapter{La percée du crâne}
	L'idée est de traquer la position d'un composant puis de transformer cette position en coordonnées pour modifier l'image. On réappliquera après le MarchingCubes afin de recréer un maillage sans les parties effacés.\\
	Les deux seuls moyens de rajouter des comportements ou des algorithmes spécifiques à une scène sont l'utilisation de Python, ou l'ajout d'un composant.\\
	Python dispose d'un système de conversion de type. Ce système permet de transformer des données C++ en données Python, et inversement, tout cela de manière transparente. Cependant, ces conversions n'ont été réalisées que pour les types les plus courants. Or, l'image est gérée et stockée grâce à une librairie spéciale appelé CImg. Les types utilisés dans cette librairie ne sont pas convertibles, il est donc impossible de modifier l'image depuis Python.\\
	Le seul moyen restant est l'utilisation d'un composant qui modifiera cette image. Ce composant devra être générique, et être inséré dans le plugin Image.
    Afin de s'intégrer dans la logique du plugin Image, il devra se trouver entre un conteneur d'image et le MarchingCubes. Il s'est donc vu ajouté une image d'entrée et une image de sortie. On copie l'image d'entrée dans l'image de sortie à chaque fois que l'image d'entrée change. Cela écrase l'image de sortie précédente. L'image d'entrée est accompagnée d'une série de paramètres appelée Transform. Cette série contient les paramètres spatiaux de l'image étudiée, et est utile afin de changer des coordonnées du repère du monde en coordonnées de l'image. 
\\    Une attention toute particulière a été apportée afin de réduire le temps d'exécution du composant.
\\    Le système de template du C++ permet une généricité lors de la compilation. Cependant, il est nécessaire de préciser toutes les combinaisons possibles dans le code. Or, on souhaite que notre composant soit le plus générique possible. Nous avons donc abandonné l'idée de traquer un composant particulier. Le tracking de composant a été remplacé par un simple champ de position. Cela rend le composant bien plus polyvalent, en permettant à l'utilisateur de choisir le point à modifier. Ce point peut être modifié en Python durant l'exécution. Le composant dispose également d'une zone de modification dans l'image ainsi que d'un booléen de marche/arrêt. Le booléen permet de simuler le bouton marche/arrêt de l'outil, et le vecteur permettra de prendre en compte la mise à l'échelle de l'image par rapport à celle du MarchingCubes.
    Enfin, en changeant la valeur des voxels dans l'image, il est possible de modifier le maillage afin de retirer des triangles ou d'en ajouter. 
    SOFA possède un mécanisme de variable dirty. Ce mécanisme sert à conserver des données tant qu'un composant ne demande pas accès à cette donnée. Actuellement, le composant force la mise à jour des composants qui dépendent de lui grâce à ce mécanisme étant donné qu'aucun autre composant ne fait appel aux données du MarchingCubes.
\section{Une autre solution}
	Une autre solution a été envisagé. Un composant SOFA permet de transformer un maillage en cubes contenant ce maillage. Il a été proposé de colorer ces maillages de cubes puis de changer leur couleur lorsque l'outil était assez proche. Mais cette solution demandais un calcul de collision bien plus lourd que ce qui est déjà implémenté. L'idée fut rejeté, malgré une partie du travail accompli.
\chapter{Haptique}
    Lors de l'opération, le chirurgien ressent la physique du patient. Il prend appui sur le crane de celui-ci, il ressent les organes qu'il touche lors de l'opération, et il utilise ces retours afin d'augmenter sa perception de la réalité. Il est possible de simuler cette perception grâce a des dispositifs haptiques.
    \section{Presentation}
L'omni est un dispositif d'interaction mécanique à retour d'effort. 
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{Omni}
  \caption{Un phantom au repos. La pointe du stylo représente le point traqué}
  \label{fig:ustl}
\end{figure}

Il possède cinq axes de rotation permettant de situer un point dans l'espace, par rapport à l'élément central, mais seulement 3 permettent de fournir un effort, sur leur axe de rotation. Il dispose malgré tout d'un positionnement à six degrés de liberté. 
\section{Implémentation}
    Ruspini, Kolarov et Khatib ont montré qu'il était possible de simuler un système de retour haptique  en simulant un point dans la scène, qui attire l'objet que l'on souhaite contrôler.\cite{HapticInteraction} Cette méthode s'appelle le god-object. Zilles et Salisbury ont ajoutés qu'il était possible de simuler différents rendus haptiques tel que la friction et la texture d'une surface de manière convaincante par des modulations précises du vecteur force appliqué à l'utilisateur dans le cas d'une modélisation god-object.\cite{GodObject}
    Ainsi, on va ajouter à la scène un objet qui sera guidé par le phantom. Cet objet servira d'objectif à atteindre pour notre outil modélisé. Pour réaliser cela, on ajoute un ressort entre les deux objets. Ce ressort va attirer l'outil à la position du phantom dans la scène et plus il sera étiré, plus les forces calculés seront importantes. 

\chapter{Les casques de réalité virtuelle}

    Il existe une règle implicite lors des opérations voulant une affectation minimale des tissus qui ne sont pas en cause dans la pathologie soignée. Afin d'atteindre cet objectif, les chirurgiens effectuent le moins d'interactions possibles. C'est pourquoi ils se sont équipés d'outils divers, parfois changeant les méthodes de travail, tels que les microscopes sur pied. 
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{microscopie-operatoire-microscope-operatoire-neurochirurgie-chirurgie-epine-dorsale-chirurgie-orl-69446-4789125}
  \caption{Un microscope opératoire. Il dispose de plusieurs filtres lumineux}
  \label{fig:ustl}
\end{figure}
Ces microscopes permettent aux chirurgiens d'opérer sur des zones très réduites, tel que les opérations intracrâniennes de l'anévrisme. Afin de s'approcher au mieux de l'expérience en bloc opératoire, il est possible d'utiliser des casques de réalité virtuelle dans le but d'émuler cet appareil.

\section{La stéréovision}
La stéréovision est le principe de perception de la 3D, c'est à dire déterminer les dimensions, formes et positions d'objets à partir de prises d'images 2D avec des angles différents. Les animaux utilisent ce principe naturellement et passivement. Les yeux capturent une image chacun, et l'envoient au cerveau par l'intermédiaire des nerfs optiques. Ces images vont être analysées par plusieurs parties du cerveau, dont une va se charger de reconstruire la scène mentalement en 3D. Pour cela, le cerveau va analyser plusieurs critères dans les images:
\begin{itemize}
\item Le parallaxe de déplacement représente le déplacement relatif des objets quand l'utilisateur se déplace lui-même. Ainsi, plus un objet est proche, plus il se déplacera rapidement
\item La taille connue des objets par l'utilisateur peut l'influencer dans la perception des tailles
\item L'occlusion correspond au recouvrement partiel d'un objet par un autre, entraînant une illusion de profondeur.
\item La perspective linéaire représente le phénomène de point de fuite, vers lequel vont se diriger les droites de la scène.
\item L'éclairage et l'ombrage sont analysés par le cerveau lors de l'analyse des formes et la position des objets dans l'espace.
\end{itemize}
    Parmi ces éléments, la taille des objets est dépendante de l'utilisateur, ce paramètre ne nous intéresse donc pas. L'occlusion et les perspectives linéaires sont gérés par le système d'affichage classique. Il est donc possible de modifier l'éclairage ainsi que les méthodes de contrôle de la caméra.

    De manière générale, la stéréovision va tenter de tromper le cerveau en utilisant les paramètres donnés plus haut. Et les deux paramètres seront gérés différemment

\section{Les casques de réalité virtuelle}
    Les casques de réalité virtuelle possèdent soit deux écrans, soit un écran fusionné. Ces deux parties d'écrans sont visibles la plupart du temps au travers de lentilles qui viennent isoler la vision de chaque ?il, ayant pour effet de n'afficher qu'une moitié d'écran à chaque ?il. Durant le reste du rapport, nous ne parlerons que des casques à écran unique. Il est possible que les techniques soient légèrement différentes pour un casque à deux écrans.
Depuis quelques années, les casques de réalité virtuelle ont eu un regain de popularité. Ces casques sont maintenant compacts, les trackeurs de position sont très précis, et les écrans intégrés disposent d'une résolution suffisante pour garantir une immersion totale. De plus, le matériel se rapproche très efficacement du microscope opératoire utilisé. 
        
\section{L'intégration}
Dans le cas de la stéréovision, nous avons besoin d'au moins deux images. Afin de réaliser cela dans SOFA, il est nécessaire d'utiliser un concept d'OPENGL particulier : Les  framebuffers.
    Les framebuffers sont des tableaux gérés par OPENGL, et contenant des pixels. Le plus utilisé est le buffer de rendu, très souvent affiché à l'écran. Tout d'abord, on réalise un premier dessin sur une partie de l'écran, puis nous dessinerons une seconde image, sur l'autre moitié. Nous avons fait le choix de n'utiliser qu'une seule caméra afin de conserver les meme propriétés de rendu.
    Maintenant que nous savons comment dessiner les images, il faut nous intéresser à la manière de positionner les images afin d'avoir la stéréovision la plus réussie.

Selon H.Yamanoue,\cite{cameraconfiguration} il existe pour cela 2 méthodes de projection :
La méthode croisée, ou toed-in
Les deux caméras sont séparées de quelques centimètres, et les normales des plans de chaque caméra se croisent en un point de l'espace.
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{VisionToedIn}
  \caption{Schéma de configuration croisée.}
  \label{fig:ustl}
\end{figure}

L'approche parallèle
Les plans des deux caméras sont parallèles l'un à l'autre.
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{visionParalelle}
  \caption{Schéma de configuration paralelle.}
  \label{fig:ustl}
\end{figure}


Une limitation technique vient des lentilles courbes des HMD, cela implique que l'image qui sera diffusée à l'utilisateur comportera des aberrations chromatiques. Ces aberrations sont intimement liées à la forme de la lentille. Plus elle sera courbée, plus les composantes seront soit approchée du centre dans le cas de la composante rouge, soit éloignée du centre dans le cas de la composante bleue. La composante verte de l'image n'étant pas affectée significativement, elle sert donc de référence pour les modifications des deux autres composantes.
    Il est possible de corriger ces aberrations chromatiques en modifiant les images initiales produites par notre pipeline OpenGL. En effet, en introduisant dans les images sources l'inverse de l'aberration chromatique observée, il est possible de recréer l'image réelle pour l'utilisateur. Et les shaders sont adaptés pour cette tâche.
Les shaders sont des programmes qui sont compilés à l'exécution du programme par les pilotes du chipset graphique, qu'il s'agisse d'une carte graphique intégrée à un processeur, ou une carte graphique dédié. Ils servent à modifier l'affichage d'un élément d'une scène 3D en appliquant des traitements sur les sommets de son maillage, ou les pixels calculés dans sa représentation 2D finale. Les shaders sont intégrés à SOFA, et il est possible d'utiliser des composants pour les ajouter à la scène. 
Grâce à ces shaders, il devient aisé d'appliquer notre modification. En effet, il suffit pour chaque pixel de sélectionner une composante plus ou moins loin, en fonction d'un ratio depuis le centre de l'image. Cette transformation est donné par la formule :
    \begin{equation}
(position.x-0.5)*factX +0.5;
\end{equation}


Où "position" contient les coordonnées du pixel courant, et FactX est le facteur attribué à la composante. Le terme 0.5 sert a centrer les coordonnées sur le point central de l'écran. Une valeur supérieure à 1 va attirer les composantes vers le centre de l'image. A l'inverse, une valeur inférieure va pousser les composantes vers les bordures.
Ce facteur est intimement dépendant des caractéristiques des lentilles disponibles sur les HMD. Il est donc nécessaire de le recalculer pour chaque lentille différente. Mais il sera également le même quel que soit la scène. Naturellement, cette modification sera visible sur l'image d'origine, si elle est diffusée sur un écran. Mais elle compensera les distorsions créées par les lentilles du HMD. C'est pourquoi il est conseillé de créer deux scènes, l'une qui tournera sur un écran classique, et l'autre qui sera sur un HMD.


\chapter{Bilan}

    Le support de l'oculus a été présenté durant le congrès de neurochirurgie. Afin de s'approcher du caractère immobile du binoculaire, un support a été réalisé afin de soutenir le casque.
\begin{figure}[!ht]
  \centering
  \includegraphics[height=8cm]{IMG_20150323_162037}
  \caption{Support pour Oculus.}
  \label{fig:ustl}
\end{figure}
Plusieurs personnes dont des étudiants en médecine et des neurochirurgiens ont testé les simulations avec et sans le casque. 
    Tout d'abord, la plupart des personnes n'ont pas trouvé l'oculus utile. Ils ont reproché de ne pas réussir à localiser les outils contrôlés par rapport au cerveau. Ils avançaient à tâtons  jusqu'à avoir une réponse visuelle ou haptique lorsqu'ils touchaient le cerveau. Cependant, le casque n'est pas en cause ici. Ceci est probablement dû au manque d'ombrage dans la scène. Afin d'améliorer ces points, il est possible d'ajouter des shaders d'ombrage aux objets.
De plus, les mouvements de caméras étaient gérés par une aide externe, avec la souris. Il est possible d'ajouter à SOFA la gestion des mouvements de la caméra par le casque lui-même.
    De plus, les testeurs ont également reproché aux outils d'avoir besoin de mouvements très amples afin de déplacer les outils. Il suffit de réduire la taille du bras mécanique dans la simulation afin de corriger le problème.

    Actuellement, la simulation de la percée du crâne permet de modifier le maillage. Dans le futur, il faudra ajouter la gestion d'un bouton qui active la percée. 
    L'appel du marchingCubes réduit les performances à 20 images par seconde sur une machine performante, ce qui est acceptable. 
    
    Le modèle de collision a été créé par simplification d'un maillage tiré du MarchingCubes. Il serait possible d'ajouter des algorithmes de décimation de maillage dans SOFA afin de générer dynamiquement un maillage simplifié au modèle de collision. Cela permettrait à son tour de généraliser la scène à n'importe quel image, et donc n'importe quel IRM de patient.
L'outil reste à une certaine distance du modèle de collision. SOFA utilise une distance minimale de détection de collision. Et cette distance doit être trop élevée, ce qui empêche l'outil de s'approcher suffisamment du crâne. En réduisant la valeur ContactDistance, dans le composant MinProximityIntersection, il est possible de réduire cette distance minimale de contact afin de régler ce problème.
    Enfin, le tracé pour l'instant n'est pas satisfaisant, car les rayures créés par l'outil ne sont pas suffisamment visibles. Il faudra tester la simulation avec une distance de collision minimale réduite, et si les résultats ne sont toujours pas acceptables, il faudra utiliser une autre méthode comme par exemple l'utilisation de particules lorsque l'outil est en contact avec le crane.


\SpecialSection{Conclusion}

De plus en plus de simulations fidèles à la réalité voient le jour dans le domaine de la médecine. Ces simulations sont actuellement destinés aux étudiants en formation afin de leur fournir un support pratique et répétable pour leurs exercices du fait de leurs imperfections.
Et les tests auprès des étudiants ont déjà commencés avec les scènes intracrâniennes 

Mais ces simulations pourront un jour être personnalisés avec les données d'un patient, et le médecin pourra utiliser des outils équivalents à ceux de son bloc pour s'exercer avant une opération importante. 

    La simulation dispose actuellement d'un outil controlé par un Phantom. Cet outil peut creuser dans un crane, mais uniquement en surface. Cela laisse une trace qui indique à l'utilisateur le chemin parcouru. De plus, le support des casques est complètement implémenté, et fonctionnel. 

Ce stage a été très enrichissant pour moi car il m'a permis de découvrir les applications de l'imagerie et de la modélisation 3D en médecine. Il m'a permis de participer à ces enjeux au travers de quelques missions auprès des neurochirurgiens où j'ai découvert une autre façon de penser, ainsi que des besoins nouveaux. De plus, il m'a permis de me familiariser avec la gestion d'un projet à plusieurs membres.  
Le travail sur SOFA m'a montré de nouvelles manières de programmer et m'a confronter aux besoins d'autres utilisateurs non informaticiens. Il m'a également permis d'approfondir mes connaissances sur les techniques de rendu d'image en opengl. Je souhaite maintenant integrer le monde professionnel dans le domaine de la modélisation 3D.

\bibliographystyle{myunsrt}
\small
\bibliography{biblio}
\Annex{Opérations de l'anévrisme}
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{scene1}
  \caption{Illustration de la phase de séparation des lobes.}
  \label{fig:ustl}
\end{figure}
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{scene2}
  \caption{Illustration de la phase de séparation de l'anévrisme.}
  \label{fig:ustl}
\end{figure}
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{scene3}
  \caption{Illustration de la phase de clippage de l'anévrisme.}
  \label{fig:ustl}
\end{figure}
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{scene4}
  \caption{Illustration de la phase de clampage de l'anévrisme après hémorragie.}
  \label{fig:ustl}
\end{figure}

\Annex{Ouverture du crane}
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{Test_00000002}
  \caption{Crane sans affichage du modèle de collision.}
  \label{fig:ustl}
\end{figure}
\begin{figure}[!ht]
  \centering
  \includegraphics[height=6cm]{Test_00000001}
  \caption{Le passage du stylo n'es visible que quand le modèle de collision est affiché}
  \label{fig:ustl}
\end{figure}
\Annex{Aberrations chromatiques}
\begin{figure}[!ht]
  \centering
  \includegraphics[height=14cm]{CaduceusOculus}
  \caption{Image après application des aberrations chromatiques dû aux lentilles}
  \label{fig:ustl}
\end{figure}
\end{document}


